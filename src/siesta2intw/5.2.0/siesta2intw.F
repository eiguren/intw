!
! Copyright (C) 2024 INTW group
!
! This file is part of INTW.
!
! INTW is free software: you can redistribute it and/or modify
! it under the terms of the GNU General Public License as published by
! the Free Software Foundation, version 3 of the License.
!
! INTW is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
! GNU General Public License for more details.
!
! You should have received a copy of the GNU General Public License
! along with this program. If not, see <https://www.gnu.org/licenses/>.
!
! ---
!
! This file is based on the siesta.F file from the SIESTA project:
!   Copyright (C) 1996-2016 The SIESTA group
!   Distributed under the terms of the GNU General Public License (GPL).
!   See the COPYING file in the original SIESTA project source for license details.
!   For the original source visit: https://siesta-project.org/siesta/
!
      Program SIESTA

      ! INTW
      USE siesta2intw_write, only: setup_write_intw, write_intw_file
      use siesta2intw_io, only: read_siesta2intw_input, find_free_unit
      use siesta2intw_io, only: siesta_output_file, stdout

      use m_siesta_init
      use m_siesta_analysis
      use m_siesta_move
      use m_siesta_end
      use m_siesta_forces
      use m_siesta_tddft
      use m_ts_global_vars, only: onlyS

      USE m_steps, only: inicoor, fincoor
      use siesta_options, only: td_elec_dyn
      use siesta_handlers_m, only: siesta_set_handlers

      use parallel, only: SIESTA_worker ! whether part of Siesta's communicator
      use parallel, only: ionode
#ifdef MPI
      use mpi_siesta, only: mpi_comm_dft ! Includes Solver nodes
#endif
      use m_mpi_utils, only: broadcast


      implicit none


      integer :: istep
      logical :: relaxd


      ! INTW
      ! Close std output and redirect all siesta output to siesta_output_file
      close(unit=6)
      open(unit=6, file=siesta_output_file)
      write(6,*) " Generated by siesta2intw to redirect SIESTA output "
      write(6,*) "----------------------------------------------------"
      write(6,*) ""
      ! NOTE: for the intel compiler the -assume noold_unit_star should be
      !       added to FFLAGS in order to print the print*, output to the
      !       desired file
      !
      ! Open /dev/stdout file in stdout unit to print all siesta2intw output
      if (ionode) then
        stdout = find_free_unit()
        open(stdout, file="/dev/stdout", status="old")
      endif
      !
      ! Read input file and open fdf_file as stdin
      call read_siesta2intw_input()
      !
      write(stdout, *) "- Running SIESTA calculation..."


! Notes for PEXSI and ELSI operation (extra procs for Solver)
!
! A subset of nodes carries out non-Solver Siesta operations
! (i.e., setting up H, moving atoms, diagonalizing...).
! These are tagged as "SIESTA_worker" (admittedly, a bad name)
! All nodes are involved in the (PEXSI or ELSI) electronic-structure solver,
! and in the new LocalDOS computation based on selected inversion.
!
! 'siesta_init', 'siesta_forces', and 'siesta_analysis' need to
! be called by all nodes.
!
! In some cases, the result of a computation by "SIESTA_worker" nodes needs
! to be broadcast to guarantee proper control-flow logic (for example,
! the "relaxd" variable from 'siesta_move'.
!
!----------------------------------------------------------------- BEGIN
!      if (ionode) call memory_snapshot("at start of program")

      call siesta_set_handlers()

      call siesta_init()

#ifdef SIESTA__PEXSI
      if (ionode) call memory_snapshot("after siesta_init")
#endif

C     Begin of coordinate relaxation iteration
      relaxd = .false.

#if defined (SIESTA__PEXSI) || defined (SIESTA__ELSI)
      ! Broadcast relevant things for program logic
      ! These were set in siesta_options, called only by "SIESTA_workers".
      call broadcast(inicoor,comm=mpi_comm_dft)
      call broadcast(fincoor,comm=mpi_comm_dft)
#endif
      istep  = inicoor
      DO WHILE ((istep.le.fincoor) .AND. (.not. relaxd))

        call timer('IterGeom', 1)

         if ( td_elec_dyn ) then
            call siesta_tddft( istep )
         else
            call siesta_forces( istep )
         end if

         if ( onlyS ) then
             call bye("Saved S only, exiting.")
         end if

        if (SIESTA_worker) call siesta_move( istep, relaxd )
#if defined (SIESTA__PEXSI) || defined (SIESTA__ELSI)
        call broadcast(relaxd,comm=mpi_comm_dft)
#endif

        call timer('IterGeom', 2)

        if (.not. relaxd) then
          istep = istep + 1
        endif
#ifdef SIESTA__PEXSI
        if (ionode) call memory_snapshot("after geometry step")
#endif

      ENDDO

      ! INTW
      call setup_write_intw()

C     End of coordinate-relaxation loop
      call siesta_analysis( relaxd )

      ! INTW
      if (ionode) call write_intw_file()

#ifdef SIESTA__PEXSI
      if (ionode) call memory_snapshot("after siesta_analysis")
#endif

      call siesta_end()
#ifdef SIESTA__PEXSI
      if (ionode) call memory_snapshot("at end of program")
#endif

#ifdef _TRACE_
      call Extrae_fini( )
#endif

!-----------------------------------------------------------------------END
      END program siesta
