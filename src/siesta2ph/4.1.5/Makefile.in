#
#  Makefile for siesta2ph
#

VPATH=@SIESTA2PH_SRC_DIR@ @SIESTA2PH_MODULES_SRC_DIR@

OBJDIR=@SIESTA_BUILD_DIR@

SPGLIB_LIBRARIES=@SPGLIB_LIBRARIES_STR@
SPGLIB_INCLUDE_FLAGS=@SPGLIB_INCLUDE_FLAGS_STR@

# ---------------------------------

ARCH_MAKE=$(OBJDIR)/arch.make
include $(ARCH_MAKE)

.SUFFIXES:
.SUFFIXES: .f .F .o .a  .f90 .F90

.PHONY: all siesta_lib siesta2ph_modules clean

FC_DEFAULT:=$(FC)
FC_SERIAL?=$(FC_DEFAULT)
FC:=$(FC_SERIAL) # Make it non-recursive

INCFLAGS += -I$(OBJDIR)
INCFLAGS += $(SPGLIB_INCLUDE_FLAGS)

FFLAGS += @SIESTA2PH_FFLAGS@

FPPFLAGS += @SIESTA2PH_FPPFLAGS@

# ---------------------------------

PROGS = siesta2ph.x siesta2fc.x siesta2dv.x
MODULES_OBJS = siesta2ph_io.o siesta2ph_linalg.o siesta2ph_utils.o siesta2ph_system.o siesta2ph_symmetry.o


SIESTA_LIB=$(OBJDIR)/libSiestaForces.a

# Find all static libraries in OBJDIR
OBJ_LIBS=$(shell find $(OBJDIR) -maxdepth 1 -name '*.a' ! -name 'libSiestaForces.a')
# Group the libraries to be searched repeatedly until all possible references are resolved.
# This helps to fix problems when the libraries are not in the correct order.
OBJ_LIBS:=-Wl,--start-group $(OBJ_LIBS) -Wl,--end-group
ALL_LIBS = $(OBJ_LIBS) $(LIBS) $(SPGLIB_LIBRARIES)

# ---------------------------------

all: $(PROGS)

siesta_lib: $(SIESTA_LIB)

siesta2ph_modules: libsiesta2ph_modules.a

libsiesta2ph_modules.a: $(MODULES_OBJS)
	$(AR) $(ARFLAGS_EXTRA) cr $@ $^

siesta2ph.x: siesta2ph.o
	$(FC) $(FFLAGS) $(LDFLAGS) -o $@ $^ libsiesta2ph_modules.a $(SIESTA_LIB) $(ALL_LIBS)

siesta2fc.x: siesta2fc.o
	$(FC) $(FFLAGS) $(LDFLAGS) -o $@ $^ libsiesta2ph_modules.a $(SIESTA_LIB) $(ALL_LIBS)

siesta2dv.x: siesta2dv.o
	$(FC) $(FFLAGS) $(LDFLAGS) -o $@ $^ libsiesta2ph_modules.a $(SIESTA_LIB) $(ALL_LIBS)

$(SIESTA_LIB):
	@( echo "Build libSiestaForces.a" \
	 ; cd $(OBJDIR) \
	 ; make \
	 ; make lib )

clean:
	@echo " Cleaning up"
	rm -f $(PROGS) *.o *.mod

# Dependencies
siesta2ph_io.o: $(SIESTA_LIB) siesta2ph_utils.o
siesta2ph_linalg.o: $(SIESTA_LIB)
siesta2ph_utils.o: $(SIESTA_LIB)
siesta2ph_system.o: $(SIESTA_LIB) siesta2ph_io.o siesta2ph_linalg.o
siesta2ph_symmetry.o: $(SIESTA_LIB) siesta2ph_io.o siesta2ph_system.o siesta2ph_linalg.o
siesta2ph.o: libsiesta2ph_modules.a $(SIESTA_LIB)
siesta2fc.o: libsiesta2ph_modules.a $(SIESTA_LIB)
siesta2dv.o: libsiesta2ph_modules.a $(SIESTA_LIB)
