QE_HOME=@QE_HOME@
W_HOME=@W_HOME@
QE_VERSION=$(shell basename ${PWD} | sed 's/QE-//')

#MPI_CMD=@MPI_CMD@

all: pw_files w90pp_files pw2intw_files intw_files w90_files intw_2_files

calculation: pw_files w90pp_files run_pw2intw run_intw run_w90 run_intw_2


.PHONY: all calculation clean run_pw run_w90pp run_pw2intw run_intw run_w90 pw_files pw2intw_files intw_files w90_files

run_pw:
	$(MPI_CMD) $(QE_HOME)/build/bin/pw.x < gaas.scf.in | tee gaas.scf.out
	( test -f CRASH && exit 1 || echo "OK" )

run_w90pp:
	$(MPI_CMD) $(W_HOME)/wannier90.x -pp gaas

run_pw2intw:
	../../../../build/src/QEtoINTW/$(QE_VERSION)/pw2intw.x < pw2intw.in | tee pw2intw.out
	( test -f CRASH && exit 1 || echo "OK" )

run_intw:
	rm -rf gaas.mmn
	../../../../build/src/utilities/intw2W90.x < intw.in | tee intw.out
	( test -f CRASH && exit 1 || echo "OK" )

run_w90:
	rm -rf gaas.wout gaas_hr.dat
	$(MPI_CMD) $(W_HOME)/wannier90.x gaas

run_intw_2:
	rm -rf gaas.u_mesh gaas_hr_intw.dat
	../../../../build/src/utilities/w902intw.x < intw.in | tee intw_w902intw.out


PW_FILES = gaas.scf.out gaas.save/data-file-schema.xml gaas.save/charge-density.dat
W90PP_FILES = gaas.nnkp
PW2INTW_FILES = pw2intw.out gaas.save.intw/crystal.dat gaas.save.intw/wfc00001.dat gaas.save.intw/iGlist.dat gaas.save.intw/1-KBPP.txt gaas.save.intw/kpoints.dat gaas.save.intw/gvectors.dat
INTW_FILES = gaas.mmn gaas.amn gaas.eig
W90_FILES = gaas.wout gaas_hr.dat
INTW_2_FILES = gaas.u_mesh gaas_hr_intw.dat

pw_files: $(PW_FILES)
w90pp_files: $(W90PP_FILES)
pw2intw_files: $(PW2INTW_FILES)
intw_files: $(INTW_FILES)
w90_files: $(W90_FILES)
intw_2_files: $(INTW_2_FILES)

gaas.scf.out:
	make run_pw
gaas.save/data-file-schema.xml:
	make run_pw
gaas.save/charge-density.dat:
	make run_pw

gaas.nnkp: $(PW_FILES)
	make run_w90pp

pw2intw.out: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/crystal.dat: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/wfc00001.dat: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/iGlist.dat: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/1-KBPP.txt: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/kpoints.dat: $(W90PP_FILES)
	make run_pw2intw
gaas.save.intw/gvectors.dat: $(W90PP_FILES)
	make run_pw2intw

gaas.mmn: $(PW2INTW_FILES)
	make run_intw
gaas.amn: $(PW2INTW_FILES)
	make run_intw
gaas.eig: $(PW2INTW_FILES)
	make run_intw

gaas.wout: $(INTW_FILES)
	make run_w90

gaas.u_mesh: $(W90_FILES)
	make run_intw_2

gaas_hr_intw.dat: $(W90_FILES)
	make run_intw_2


clean:
	rm -rf gaas.scf.out gaas.xml gaas.wfc* gaas.save
	rm -rf pw2intw.out gaas.save.intw
	rm -rf intw.out gaas.mmn gaas.amn gaas.eig
	rm -rf gaas.wout gaas_band.* gaas.chk gaas.werr gaas.nnkp
	rm -rf gaas.u_mesh gaas_hr_intw.dat

