#!/usr/bin/env bash

QE_HOME=@QE_HOME@
QE_VERSION=$(basename $PWD | sed 's/QE-//')

NUM_BANDS=15
NAT=2
NON_DEGENERATED_BANDS=( 1 2 5 6 9 14 )

MIN_MAT_EL=0.0001
MAX_DIFF_PERCENTAGE=0.15


# Run all necessary QE calculations
make calculation
if [ $? -ne 0 ]; then
  exit 1
fi




# Run the matrix-element calculation
cp ../intw.in ./
../../../../build/src/utilities/ep_melements_noW.x < intw.in | tee intw.out



# Compare calculation
REFERENCE_MAT_FILE=reference/ep_mat.dat_1
TEST_MAT_FILE=ep_mat.dat_1


rm -rf reference_file
touch reference_file
rm -rf test_file
touch test_file
NMODES=$(echo 3*$NAT | bc -l)
for NU in $(seq $NMODES);
do
  for M in $(seq $NUM_BANDS);
  do
    for N in $(seq $NUM_BANDS);
    do
      J=$(echo "16*$NUM_BANDS*$NUM_BANDS*($NU-1) + 16*$NUM_BANDS*($M-1) + 16*($N-1)" | bc -l)
      echo $N $M $NU $(od -A d -t f8 -j $J -N 16 $REFERENCE_MAT_FILE | head -n 1 | tr "," "."| awk '{printf("%15.10f%15.10f    %15.10f\n",$2,$3,sqrt($2**2+$3**2))}') | awk '{printf("%2i %2i %2i %15.10f\n",$1,$2,$3,$6)}' >> reference_file
      echo $N $M $NU $(od -A d -t f8 -j $J -N 16 $TEST_MAT_FILE | head -n 1 | tr "," "."| awk '{printf("%15.10f%15.10f    %15.10f\n",$2,$3,sqrt($2**2+$3**2))}') | awk '{printf("%2i %2i %2i %15.10f\n",$1,$2,$3,$6)}' >> test_file
    done
  done
done


echo "iband jband imode                 mat1                 mat2                 diff           percentage"
while IFS= read -r line
do
  #
  iband=$(echo $line | awk '{print $1}')
  iband_=$(echo $line | awk '{print $5}')
  if [[ ! " ${iband} " =~ " ${iband_} " ]]; then
    echo "Error on iband index"
    rm reference_file test_file
    exit 1
  fi
  #
  jband=$(echo $line | awk '{print $2}')
  jband_=$(echo $line | awk '{print $6}')
  if [[ ! " ${jband} " =~ " ${jband_} " ]]; then
    echo "Error on jband index"
    rm reference_file test_file
    exit 1
  fi
  #
  imode=$(echo $line | awk '{print $3}')
  imode_=$(echo $line | awk '{print $7}')
  if [[ ! " ${imode} " =~ " ${imode_} " ]]; then
    echo "Error on mode index"
    rm reference_file test_file
    exit 1
  fi
  #
  if [[ " ${NON_DEGENERATED_BANDS[@]} " =~ " ${iband} " ]]; then
    if [[ " ${NON_DEGENERATED_BANDS[@]} " =~ " ${jband} " ]]; then
      MAT_EL=$(echo $line | awk '{printf("%20.15f", $4)}')
      if (( $(echo "$MAT_EL > $MIN_MAT_EL" | bc -l) )); then
        echo $line | awk '{printf( "%5i %5i %5i %20.15f %20.15f %20.15f %20.5f\n", $1,$2,$3,$4,$8,$4-$8,($4-$8)/$4*100)}'
        DIFF_PERCENTAGE=$(echo $line | awk '{printf( "%20.5f\n", sqrt((($4-$8)/$4*100)**2) )}')
        if (( $(echo "$DIFF_PERCENTAGE > $MAX_DIFF_PERCENTAGE" | bc -l) )); then
          echo "MAX_DIFF_PERCENTAGE exceeded!"
          rm reference_file test_file
          exit 1
        fi
      fi
    fi
  fi
done <<< $(paste reference_file test_file)

rm reference_file test_file
