
QE_BUILD_DIR=@QE_BUILD_DIR@

#MPI_CMD=@MPI_CMD@


all: scf_files ph_files q2r_files

calculation: all


.PHONY: all calculation clean run_scf run_ph run_q2r scf_files ph_files q2r_files


run_scf:
	$(QE_BUILD_DIR)/bin/pw.x < cu.scf.in | tee cu.scf.out
	( test -f CRASH && exit 1 || echo "OK" )

run_ph1:
	cp -r cu.save qq1/
	( cd qq1 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph2:
	cp -r cu.save qq2/
	( cd qq2 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph3:
	cp -r cu.save qq3/
	( cd qq3 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph4:
	cp -r cu.save qq4/
	( cd qq4 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph5:
	cp -r cu.save qq5/
	( cd qq5 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph6:
	cp -r cu.save qq6/
	( cd qq6 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph7:
	cp -r cu.save qq7/
	( cd qq7 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph8:
	cp -r cu.save qq8/
	( cd qq8 ; $(QE_BUILD_DIR)/bin/ph.x < cu.ph.in | tee cu.ph.out ; rm -rf cu.save ; test -f CRASH && exit 1 || echo "OK" )

run_q2r:
	rm -rf CRASH
	cp qq1/cu.dyn ./cu.dyn1
	cp qq2/cu.dyn ./cu.dyn2
	cp qq3/cu.dyn ./cu.dyn3
	cp qq4/cu.dyn ./cu.dyn4
	cp qq5/cu.dyn ./cu.dyn5
	cp qq6/cu.dyn ./cu.dyn6
	cp qq7/cu.dyn ./cu.dyn7
	cp qq8/cu.dyn ./cu.dyn8
	$(QE_BUILD_DIR)/bin/q2r.x < q2r.in | tee q2r.out
	( test -f CRASH && exit 1 || echo "OK" )


SCF_FILES = cu.scf.out cu.save/data-file-schema.xml cu.save/charge-density.dat cu.save/wfc64.dat
PH_FILES_Q1 = qq1/cu.ph.out qq1/cu.dyn qq1/_ph0/cu.dvscf1 qq1/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q2 = qq2/cu.ph.out qq2/cu.dyn qq2/_ph0/cu.dvscf1 qq2/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q3 = qq3/cu.ph.out qq3/cu.dyn qq3/_ph0/cu.dvscf1 qq3/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q4 = qq4/cu.ph.out qq4/cu.dyn qq4/_ph0/cu.dvscf1 qq4/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q5 = qq5/cu.ph.out qq5/cu.dyn qq5/_ph0/cu.dvscf1 qq5/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q6 = qq6/cu.ph.out qq6/cu.dyn qq6/_ph0/cu.dvscf1 qq6/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q7 = qq7/cu.ph.out qq7/cu.dyn qq7/_ph0/cu.dvscf1 qq7/_ph0/cu.phsave/patterns.1.xml
PH_FILES_Q8 = qq8/cu.ph.out qq8/cu.dyn qq8/_ph0/cu.dvscf1 qq8/_ph0/cu.phsave/patterns.1.xml
PH_FILES = $(PH_FILES_Q1) $(PH_FILES_Q2) $(PH_FILES_Q3) $(PH_FILES_Q4) $(PH_FILES_Q5) $(PH_FILES_Q6) $(PH_FILES_Q7) $(PH_FILES_Q8)
Q2R_FILES = q2r.out cu.fc


scf_files: $(SCF_FILES)
ph_files: $(PH_FILES)
q2r_files: $(Q2R_FILES)


cu.scf.out:
	make run_scf
cu.save/data-file-schema.xml:
	make run_scf
cu.save/charge-density.dat:
	make run_scf
cu.save/wfc64.dat:
	make run_scf

qq1/cu.ph.out: $(SCF_FILES)
	make run_ph1
qq2/cu.ph.out: $(SCF_FILES)
	make run_ph2
qq3/cu.ph.out: $(SCF_FILES)
	make run_ph3
qq4/cu.ph.out: $(SCF_FILES)
	make run_ph4
qq5/cu.ph.out: $(SCF_FILES)
	make run_ph5
qq6/cu.ph.out: $(SCF_FILES)
	make run_ph6
qq7/cu.ph.out: $(SCF_FILES)
	make run_ph7
qq8/cu.ph.out: $(SCF_FILES)
	make run_ph8

qq1/cu.dyn: $(SCF_FILES)
	make run_ph1
qq2/cu.dyn: $(SCF_FILES)
	make run_ph2
qq3/cu.dyn: $(SCF_FILES)
	make run_ph3
qq4/cu.dyn: $(SCF_FILES)
	make run_ph4
qq5/cu.dyn: $(SCF_FILES)
	make run_ph5
qq6/cu.dyn: $(SCF_FILES)
	make run_ph6
qq7/cu.dyn: $(SCF_FILES)
	make run_ph7
qq8/cu.dyn: $(SCF_FILES)
	make run_ph8

qq1/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph1
qq2/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph2
qq3/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph3
qq4/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph4
qq5/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph5
qq6/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph6
qq7/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph7
qq8/_ph0/cu.dvscf1: $(SCF_FILES)
	make run_ph8

qq1/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph1
qq2/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph2
qq3/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph3
qq4/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph4
qq5/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph5
qq6/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph6
qq7/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph7
qq8/_ph0/cu.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph8

q2r.out: $(PH_FILES)
	make run_q2r
cu.fc: $(PH_FILES)
	make run_q2r


clean:
	rm -rf cu.scf.out cu.xml cu.wfc* cu.save
	rm -rf qq1/cu.dyn qq1/cu.ph.out qq1/cu.wfc* qq1/_ph0 qq1/cu.save
	rm -rf qq2/cu.dyn qq2/cu.ph.out qq2/cu.wfc* qq2/_ph0 qq1/cu.save
	rm -rf qq3/cu.dyn qq3/cu.ph.out qq3/cu.wfc* qq3/_ph0 qq1/cu.save
	rm -rf qq4/cu.dyn qq4/cu.ph.out qq4/cu.wfc* qq4/_ph0 qq1/cu.save
	rm -rf qq5/cu.dyn qq5/cu.ph.out qq5/cu.wfc* qq5/_ph0 qq1/cu.save
	rm -rf qq6/cu.dyn qq6/cu.ph.out qq6/cu.wfc* qq6/_ph0 qq1/cu.save
	rm -rf qq7/cu.dyn qq7/cu.ph.out qq7/cu.wfc* qq7/_ph0 qq1/cu.save
	rm -rf qq8/cu.dyn qq8/cu.ph.out qq8/cu.wfc* qq8/_ph0 qq1/cu.save
	rm -rf q2r.out cu.fc cu.dyn1 cu.dyn2 cu.dyn3 cu.dyn4 cu.dyn5 cu.dyn6 cu.dyn7 cu.dyn8
	rm -rf pw2intw.out cu.save.intw
	rm -rf intw.out ep_mat.dat_*
