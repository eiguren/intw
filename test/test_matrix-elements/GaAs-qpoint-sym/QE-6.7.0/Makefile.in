
QE_HOME=@QE_HOME@
QE_VERSION=$(shell basename ${PWD} | sed 's/QE-//')
BUILD_DIR=@CMAKE_BINARY_DIR@

#MPI_CMD=@MPI_CMD@


all: scf_files ph_files q2r_files nscf_files nscf_pw2intw_files

calculation: all


.PHONY: all calculation clean run_scf run_ph run_q2r run_nscf run_nscf_pw2intw scf_files ph_files q2r_files nscf_files nscf_pw2intw_files

run_scf:
	$(QE_HOME)/build/bin/pw.x < gaas.scf.in | tee gaas.scf.out
	( test -f CRASH && exit 1 || echo "OK" )

run_ph1:
	cp -r gaas.save qq1/
	( cd qq1 ; $(QE_HOME)/build/bin/ph.x < gaas.ph.in | tee gaas.ph.out ; rm -rf gaas.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph2:
	cp -r gaas.save qq2/
	( cd qq2 ; $(QE_HOME)/build/bin/ph.x < gaas.ph.in | tee gaas.ph.out ; rm -rf gaas.save ; test -f CRASH && exit 1 || echo "OK" )
run_ph3:
	cp -r gaas.save qq3/
	( cd qq3 ; $(QE_HOME)/build/bin/ph.x < gaas.ph.in | tee gaas.ph.out ; rm -rf gaas.save ; test -f CRASH && exit 1 || echo "OK" )

run_q2r:
	rm -rf CRASH
	cp qq1/gaas.dyn ./gaas.dyn1
	cp qq2/gaas.dyn ./gaas.dyn2
	cp qq3/gaas.dyn ./gaas.dyn3
	$(QE_HOME)/build/bin/q2r.x < q2r.in | tee q2r.out
	( test -f CRASH && exit 1 || echo "OK" )

run_nscf:
	rm -rf gaas-nscf.save
	cp -r gaas.save gaas-nscf.save
	$(MPI_CMD) $(QE_HOME)/build/bin/pw.x < gaas.nscf.in | tee gaas.nscf.out

run_nscf_pw2intw:
	$(BUILD_DIR)/src/QEtoINTW/${QE_VERSION}/pw2intw.x < nscf.pw2intw.in | tee nscf.pw2intw.out


SCF_FILES = gaas.scf.out gaas.save/data-file-schema.xml gaas.save/charge-density.dat gaas.save/wfc8.dat
PH_FILES_Q1 = qq1/gaas.ph.out qq1/gaas.dyn qq1/_ph0/gaas.dvscf1 qq1/_ph0/gaas.phsave/patterns.1.xml
PH_FILES_Q2 = qq2/gaas.ph.out qq2/gaas.dyn qq2/_ph0/gaas.dvscf1 qq2/_ph0/gaas.phsave/patterns.1.xml
PH_FILES_Q3 = qq3/gaas.ph.out qq3/gaas.dyn qq3/_ph0/gaas.dvscf1 qq3/_ph0/gaas.phsave/patterns.1.xml
PH_FILES = $(PH_FILES_Q1) $(PH_FILES_Q2) $(PH_FILES_Q3)
Q2R_FILES = q2r.out gaas.fc
NSCF_FILES = gaas.nscf.out gaas-nscf.save/data-file-schema.xml gaas-nscf.save/charge-density.dat gaas-nscf.save/wfc64.dat
NSCF_PW2INTW_FILES = nscf.pw2intw.out gaas-nscf.save.intw/crystal.dat gaas-nscf.save.intw/wfc00064.dat


scf_files: $(SCF_FILES)
ph_files: $(PH_FILES)
q2r_files: $(Q2R_FILES)
nscf_files: $(NSCF_FILES)
nscf_pw2intw_files: $(NSCF_PW2INTW_FILES)


gaas.scf.out:
	make run_scf
gaas.save/data-file-schema.xml:
	make run_scf
gaas.save/charge-density.dat:
	make run_scf
gaas.save/wfc8.dat:
	make run_scf

qq1/gaas.ph.out: $(SCF_FILES)
	make run_ph1
qq2/gaas.ph.out: $(SCF_FILES)
	make run_ph2
qq3/gaas.ph.out: $(SCF_FILES)
	make run_ph3

qq1/gaas.dyn: $(SCF_FILES)
	make run_ph1
qq2/gaas.dyn: $(SCF_FILES)
	make run_ph2
qq3/gaas.dyn: $(SCF_FILES)
	make run_ph3

qq1/_ph0/gaas.dvscf1: $(SCF_FILES)
	make run_ph1
qq2/_ph0/gaas.dvscf1: $(SCF_FILES)
	make run_ph2
qq3/_ph0/gaas.dvscf1: $(SCF_FILES)
	make run_ph3

qq1/_ph0/gaas.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph1
qq2/_ph0/gaas.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph2
qq3/_ph0/gaas.phsave/patterns.1.xml: $(SCF_FILES)
	make run_ph3

q2r.out: $(PH_FILES)
	make run_q2r
gaas.fc: $(PH_FILES)
	make run_q2r

gaas.nscf.out: $(SCF_FILES)
	make run_nscf
gaas-nscf.save/data-file-schema.xml: $(SCF_FILES)
	make run_nscf
gaas-nscf.save/charge-density.dat: $(SCF_FILES)
	make run_nscf
gaas-nscf.save/wfc64.dat: $(SCF_FILES)
	make run_nscf

nscf.pw2intw.out: $(NSCF_FILES)
	make run_nscf_pw2intw
gaas-nscf.save.intw/crystal.dat: $(NSCF_FILES)
	make run_nscf_pw2intw
gaas-nscf.save.intw/wfc00064.dat: $(NSCF_FILES)
	make run_nscf_pw2intw


clean:
	rm -rf gaas.scf.out gaas.xml gaas.wfc* gaas.save
	rm -rf qq1/gaas.dyn qq1/gaas.ph.out qq1/gaas.wfc* qq1/_ph0 qq1/gaas.save
	rm -rf qq2/gaas.dyn qq2/gaas.ph.out qq2/gaas.wfc* qq2/_ph0 qq2/gaas.save
	rm -rf qq3/gaas.dyn qq3/gaas.ph.out qq3/gaas.wfc* qq3/_ph0 qq3/gaas.save
	rm -rf q2r.out gaas.fc gaas.dyn1 gaas.dyn2 gaas.dyn3
	rm -rf gaas.nscf.out gaas-nscf.xml gaas-nscf.wfc* gaas-nscf.save
	rm -rf nscf.pw2intw.out cu-nscf.save.intw
	rm -rf pw2intw.out gaas.save.intw
	rm -rf intw.out ep_mat.dat_*
