
QE_HOME=@QE_HOME@
W_HOME=@W_HOME@
QE_VERSION=$(shell basename ${PWD} | sed 's/QE-//')

#MPI_CMD=@MPI_CMD@

all: pw_files w90pp_files pw2wannier90_files pw2intw_files

calculation: all


.PHONY: all calculation clean run_pw run_w90pp run_pw2wannier90 run_pw2intw pw_files pw2intw_files

run_pw:
	$(MPI_CMD) $(QE_HOME)/build/bin/pw.x < si.scf.in | tee si.scf.out
	( test -f CRASH && exit 1 || echo "OK" )
	$(MPI_CMD) $(QE_HOME)/build/bin/pw.x < si.nscf.in | tee si.nscf.out
	( test -f CRASH && exit 1 || echo "OK" )

run_w90pp:
	$(MPI_CMD) $(W_HOME)/wannier90.x -pp si

run_pw2wannier90:
	$(MPI_CMD) $(QE_HOME)/build/bin/pw2wannier90.x < si.pw2wannier.in | tee si.pw2wannier.out
	( test -f CRASH && exit 1 || echo "OK" )
	cp si.mmn qe_si.mmn

run_pw2intw:
	../../../../build/src/QEtoINTW/$(QE_VERSION)/pw2intw.x < pw2intw.in | tee pw2intw.out
	( test -f CRASH && exit 1 || echo "OK" )

PW_FILES = si.scf.out si.save/data-file-schema.xml si.save/charge-density.dat
W90PP_FILES = si.nnkp
PW2WANNIER90_FILES = si.mmn
PW2INTW_FILES = pw2intw.out si.save.intw/crystal.dat si.save.intw/wfc00001.dat si.save.intw/iGlist.dat si.save.intw/1-KBPP.txt si.save.intw/si.dvscf_q1 si.save.intw/kpoints.dat si.save.intw/si.dyn_q1 si.save.intw/gvectors.dat si.save.intw/irrq_patterns.dat
pw_files: $(PW_FILES)
w90pp_files: $(W90PP_FILES)
pw2wannier90_files: $(PW2WANNIER90_FILES)
pw2intw_files: $(PW2INTW_FILES)

si.scf.out:
	make run_pw
si.nscf.out:
	make run_pw
si.save/data-file-schema.xml:
	make run_pw
si.save/charge-density.dat:
	make run_pw

si.nnkp: $(PW_FILES)
	make run_w90pp

si.mmn: $(W90PP_FILES)
	make run_pw2wannier90

pw2intw.out: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/crystal.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/wfc00001.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/iGlist.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/1-KBPP.txt: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/si.dvscf_q1: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/kpoints.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/si.dyn_q1: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/gvectors.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw
si.save.intw/irrq_patterns.dat: $(PW2WANNIER90_FILES)
	make run_pw2intw

clean:
	rm -rf si.scf.out si.xml si.wfc* si.save
	rm -rf pw2intw.out si.save.intw
	rm -rf intw.out si.mmn si.amn si.eig
